# CSRFについて

## クロスサイトリクエストフォージェリ
* クロスサイトリクエストフォージェリ
* forgeryは偽装の意味

オンラインサービスを利用するユーザーがログイン状態を保持したまま悪意のある第三者の作成したURLなどをクリックした場合などに、本人が意図しない形で情報・リクエストを送信されてしまうことを意味します。
クロスサイトリクエストフォージェリの一例として、SNSにログインしたままの状態で、他のサイトで興味深いURLをクリックします。クリックされたURLにはSNSに勝手に投稿する仕組みが備わっており、悪意のある第三者が用意した文章を勝手に発信されてしまいます。
クロスサイトリクエストフォージェリによる事例を調べたところ、SNSで意図しない情報を発信されてしまうだけでなく、犯罪予告などを発信されてしまい、誤認逮捕まで進んでしまった例もあります。

掲示板や問い合わせフォームなどを処理するWebアプリケーションが、本来拒否すべき他サイトからのリクエストを受信し処理してしまいます。

NSなどのオンラインサービスを利用している際にログイン状態を保持したまま、たまたま気になった別のサイトを閲覧したことがあるという人は多いのではないでしょうか。csrfとは、このようなログイン状態を狙った攻撃です。


## 攻撃の手法・特徴
* 攻撃者は攻撃用Webページを準備し、ユーザがアクセスするよう誘導します
* ユーザが攻撃用Webページにアクセスすると、攻撃用Webページ内にあらかじめ用意されていた不正なリクエストが攻撃対象サーバに送られます
* 攻撃対象サーバ上のWebアプリケーションは不正なリクエストを処理し、ユーザが意図していない処理が行われてしまいます

## 影響と被害
* 攻撃者は自身が直接攻撃対象サーバへアクセスすることなく、攻撃対象のWebアプリケーションに任意の処理を行わせることができます。

* いたずら的書き込み、不正サイトへの誘導、犯罪予告といった掲示板やアンケートフォームへの不正な書き込み
* 不正な書き込みを大量に行うことによるDoS攻撃

攻撃Webページに誘導された一般ユーザには直接的な被害はありません。ただし、攻撃対象サーバへの不正なリクエストを送信した攻撃者として認識されてしまうことがあります

## 対策と予防(WEB管理者側)
* 根本的な解決のためには、Webアプリケーション側でサイト外からのリクエストを受信、処理しないようにシステムを作りこむ必要があります
* 攻撃者に推測されにくい任意の情報を照合する処理を実装する。照合に使う任意の情報の例としては、セッションID、ページトークン、ランダムな数字などがあります
* 画像化されたチェックコードを表示しユーザに入力させる「キャプチャ」機能を実装する

## CSRFで起こりえる被害について

## サービス提供者がとるべきCSRFの対策
サービス提供者がクロスサイトリクエストフォージェリの対策を考える場合、システム面で防ぐ他ありません。クロスサイトリクエストフォージェリはいわば外部からの不正なリクエストをシステム内で処理してしまうことが問題だからです。

サービス提供者が考えるべき対策の一つに、どこから送られたリクエストなのか。このリクエストはユーザーが送ったものなのかを照合するシステムや、送信元のURLに対する照合、リクエストを送る時のパラメータに対する照合など、必要に合わせて適用し、脆弱性を排除しておくことが求められます。言い方を変えれば、サービス提供者がしっかりとしていれば、ユーザーがクロスサイトリクエストフォージェリによる被害を受けなくて済む可能性も高くなるという意味合いです。


## CSRF Token
### Laravel 
* Laravelは、アプリケーションによって管理されている**アクティブなユーザーセッションごとにCSRF「トークン」を自動的に生成**します。
* このトークンは、**認証済みユーザーが実際にアプリケーションへリクエストを行っているユーザーであることを確認**するために使用されます。
* このトークンはユーザーのセッションに保存され、セッションが再生成されるたびに変更されるため、悪意のあるアプリケーションはこのトークンへアクセスできません。

```
use Illuminate\Http\Request;

Route::get('/token', function (Request $request) {
    $token = $request->session()->token();

    $token = csrf_token();

    // ...
});
```

